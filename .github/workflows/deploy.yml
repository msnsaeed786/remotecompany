name: Deployment on Kubernetes
on:
  workflow_run:
    workflows: ["Docker_Image_CI"]
    branches: [main]
    types: 
      - completed

jobs:

  Deploy_on_Kubernetes:
    name: Build, push, and deploy
    runs-on: ubuntu-latest
    steps:

    - name: Checkout master
      uses: actions/checkout@master

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
        
    - name: Save DigitalOcean kubeconfig with short-lived credentials
      run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 6231dff1-cf42-49f7-9663-7c2827d1120a

    - name: Deploy to DigitalOcean Kubernetes
      run: kubectl apply -f $GITHUB_WORKSPACE/deploy/deployment.yml

    - name: Verify deployment
      run: kubectl rollout status deployment/remote-app
